<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    Dubbo进阶（七）：Dubbo扩展点加载机制（下） |
    
    Wry&#39;s blog</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
<main class="content">
  <section class="outer">
  <article id="post-Dubbo进阶（七）：Dubbo扩展点加载机制（下）" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h1 class="article-title" itemprop="name">
      Dubbo进阶（七）：Dubbo扩展点加载机制（下）
    </h1>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2020/05/09/Dubbo%E8%BF%9B%E9%98%B6%EF%BC%88%E4%B8%83%EF%BC%89%EF%BC%9ADubbo%E6%89%A9%E5%B1%95%E7%82%B9%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%EF%BC%88%E4%B8%8B%EF%BC%89/" class="article-date">
  <time datetime="2020-05-09T10:04:51.000Z" itemprop="datePublished">2020-05-09</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/Dubbo/">Dubbo</a>
  </div>

                    </div>
                    

                        
                            
    <div class="tocbot"></div>





                                

                                    <div class="article-entry" itemprop="articleBody">
                                        

                                            

                                                
                                                                    <p>在上一篇文章<a href="https://blog.csdn.net/wangchengming1/article/details/105814034" target="_blank" rel="noopener">Dubbo进阶（六）：Dubbo扩展点加载机制（中）</a>中介绍了扩展点机制的一些注解，这篇文章主要通过源码来学习一下<code>ExtensionLoader</code>的原理。<code>ExtensionLoader</code>是整个扩展机制的主要逻辑，在这个类里实现了配置的加载、扩展类缓存、自适应对象生成等所有工作。</p>
<a id="more"></a>
<p>在上一篇文章<a href="https://blog.csdn.net/wangchengming1/article/details/105814034" target="_blank" rel="noopener">Dubbo进阶（六）：Dubbo扩展点加载机制（中）</a>中介绍了扩展点机制的一些注解，这篇文章主要通过源码来学习一下<code>ExtensionLoader</code>的原理。<code>ExtensionLoader</code>是整个扩展机制的主要逻辑，在这个类里实现了配置的加载、扩展类缓存、自适应对象生成等所有工作。</p>
<h5 id="ExtensionLoader的工作流程"><a href="#ExtensionLoader的工作流程" class="headerlink" title="ExtensionLoader的工作流程"></a>ExtensionLoader的工作流程</h5><p>ExtensionLoader的逻辑入口可以分为<code>getExtension</code>、<code>getAdaptiveExtension</code>和<code>getActivateExtension</code>三个，分别是获取普通扩展类、获取自动适应扩展类和获取自动激活扩展类。</p>
<p><img src="https://img-blog.csdnimg.cn/20200507181949568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dhbmdjaGVuZ21pbmcx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h5 id="getExtension的实现原理"><a href="#getExtension的实现原理" class="headerlink" title="getExtension的实现原理"></a>getExtension的实现原理</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 根据name获取扩展点实现的实例</span><br><span class="line">public T getExtension(String name) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果没有给出指定的name，抛出异常</span><br><span class="line">    if (StringUtils.isEmpty(name)) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;Extension name &#x3D;&#x3D; null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 如果name&#x3D;true，则返回默认的扩展类</span><br><span class="line">    if (&quot;true&quot;.equals(name)) &#123;</span><br><span class="line">   		&#x2F;&#x2F; 详细逻辑请看下面第二段代码块</span><br><span class="line">        return getDefaultExtension();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 获取扩展对象，Holder里的value属性保存着扩展对象实例</span><br><span class="line">    final Holder&lt;Object&gt; holder &#x3D; getOrCreateHolder(name);</span><br><span class="line">    Object instance &#x3D; holder.get();</span><br><span class="line">    &#x2F;&#x2F; 使用双重检查锁</span><br><span class="line">    if (instance &#x3D;&#x3D; null) &#123;</span><br><span class="line">        synchronized (holder) &#123;</span><br><span class="line">            instance &#x3D; holder.get();</span><br><span class="line">            if (instance &#x3D;&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; 创建扩展对象，详细逻辑请看第三段代码块</span><br><span class="line">                instance &#x3D; createExtension(name);</span><br><span class="line">                holder.set(instance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>———————第二段代码块，华丽丽的分割线————————</p>
<p>接下来是获取默认<code>extension</code>的逻辑。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public T getDefaultExtension() &#123;</span><br><span class="line">    &#x2F;&#x2F; 加载默认</span><br><span class="line">    getExtensionClasses();</span><br><span class="line">    if (StringUtils.isBlank(cachedDefaultName) || &quot;true&quot;.equals(cachedDefaultName)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    return getExtension(cachedDefaultName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">    &#x2F;&#x2F; 尝试先从缓存中获取classes</span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; classes &#x3D; cachedClasses.get();</span><br><span class="line">    &#x2F;&#x2F; 如果缓存中没有，则开始加载class</span><br><span class="line">    if (classes &#x3D;&#x3D; null) &#123;</span><br><span class="line">        synchronized (cachedClasses) &#123;</span><br><span class="line">            classes &#x3D; cachedClasses.get();</span><br><span class="line">            if (classes &#x3D;&#x3D; null) &#123;</span><br><span class="line">                classes &#x3D; loadExtensionClasses();</span><br><span class="line">                cachedClasses.set(classes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">    &#x2F;&#x2F; 检查是否有@SPI注解，如果有则获取注解中的名字并缓存为默认的实现。</span><br><span class="line">    cacheDefaultExtensionName();</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; extensionClasses &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    for (LoadingStrategy strategy : strategies) &#123;</span><br><span class="line">        &#x2F;&#x2F; 加载配置文件</span><br><span class="line">        loadDirectory(extensionClasses, strategy.directory(), type.getName(), strategy.preferExtensionClassLoader(), strategy.excludedPackages());</span><br><span class="line">        &#x2F;&#x2F; 由于 Dubbo 迁到 apache ，所以包名有变化，会替换之前的 alibaba 为 apache</span><br><span class="line">        loadDirectory(extensionClasses, strategy.directory(), type.getName().replace(&quot;org.apache&quot;, &quot;com.alibaba&quot;), strategy.preferExtensionClassLoader(), strategy.excludedPackages());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return extensionClasses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private void loadDirectory(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir, String type,</span><br><span class="line">                           boolean extensionLoaderClassLoaderFirst, String... excludedPackages) &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取文件在项目中的路径，如：META-INF&#x2F;dubbo&#x2F;top.ytao.demo.spi.AnimalService</span><br><span class="line">    String fileName &#x3D; dir + type;</span><br><span class="line">    try &#123;</span><br><span class="line">        Enumeration&lt;java.net.URL&gt; urls &#x3D; null;</span><br><span class="line">        ClassLoader classLoader &#x3D; findClassLoader();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 加载内部扩展类</span><br><span class="line">        if (extensionLoaderClassLoaderFirst) &#123;</span><br><span class="line">            ClassLoader extensionLoaderClassLoader &#x3D; ExtensionLoader.class.getClassLoader();</span><br><span class="line">            if (ClassLoader.getSystemClassLoader() !&#x3D; extensionLoaderClassLoader) &#123;</span><br><span class="line">                urls &#x3D; extensionLoaderClassLoader.getResources(fileName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 加载当前 fileName 文件</span><br><span class="line">        if(urls &#x3D;&#x3D; null || !urls.hasMoreElements()) &#123;</span><br><span class="line">            if (classLoader !&#x3D; null) &#123;</span><br><span class="line">                urls &#x3D; classLoader.getResources(fileName);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                urls &#x3D; ClassLoader.getSystemResources(fileName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (urls !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; 迭代加载同名文件的内容</span><br><span class="line">            while (urls.hasMoreElements()) &#123;</span><br><span class="line">                java.net.URL resourceURL &#x3D; urls.nextElement();</span><br><span class="line">                &#x2F;&#x2F; 加载文件内容</span><br><span class="line">                loadResource(extensionClasses, classLoader, resourceURL, excludedPackages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        logger.error(&quot;Exception occurred when loading extension class (interface: &quot; +</span><br><span class="line">                type + &quot;, description file: &quot; + fileName + &quot;).&quot;, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private void loadResource(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader,</span><br><span class="line">                          java.net.URL resourceURL, String... excludedPackages) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        try (BufferedReader reader &#x3D; new BufferedReader(new InputStreamReader(resourceURL.openStream(), StandardCharsets.UTF_8))) &#123;</span><br><span class="line">            String line;</span><br><span class="line">            &#x2F;&#x2F; 整行读取文件内容</span><br><span class="line">            while ((line &#x3D; reader.readLine()) !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; 获取当前行中第一个 &quot;#&quot; 的位置索引</span><br><span class="line">                final int ci &#x3D; line.indexOf(&#39;#&#39;);</span><br><span class="line">                &#x2F;&#x2F; 如果当前行存在 &quot;#&quot;,则去除 &quot;#&quot; 后的内容</span><br><span class="line">                if (ci &gt;&#x3D; 0) &#123;</span><br><span class="line">                    line &#x3D; line.substring(0, ci);</span><br><span class="line">                &#125;</span><br><span class="line">                line &#x3D; line.trim();</span><br><span class="line">                if (line.length() &gt; 0) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        String name &#x3D; null;</span><br><span class="line">                        &#x2F;&#x2F; 获取当前行 &quot;&#x3D;&quot; 的索引</span><br><span class="line">                        int i &#x3D; line.indexOf(&#39;&#x3D;&#39;);</span><br><span class="line">                        &#x2F;&#x2F; 如果当前行存在 &quot;&#x3D;&quot;，将 &quot;&#x3D;&quot; 左右的值分开复制给 name 和 line</span><br><span class="line">                        if (i &gt; 0) &#123;</span><br><span class="line">                            name &#x3D; line.substring(0, i).trim();</span><br><span class="line">                            line &#x3D; line.substring(i + 1).trim();</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (line.length() &gt; 0 &amp;&amp; !isExcluded(line, excludedPackages)) &#123;</span><br><span class="line">                            &#x2F;&#x2F; 加载扩展类</span><br><span class="line">                            loadClass(extensionClasses, resourceURL, Class.forName(line, true, classLoader), name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (Throwable t) &#123;</span><br><span class="line">                        IllegalStateException e &#x3D; new IllegalStateException(&quot;Failed to load extension class (interface: &quot; + type + &quot;, class line: &quot; + line + &quot;) in &quot; + resourceURL + &quot;, cause: &quot; + t.getMessage(), t);</span><br><span class="line">                        exceptions.put(line, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        logger.error(&quot;Exception occurred when loading extension class (interface: &quot; +</span><br><span class="line">                type + &quot;, class file: &quot; + resourceURL + &quot;) in &quot; + resourceURL, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private void loadClass(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, java.net.URL resourceURL, Class&lt;?&gt; clazz, String name) throws NoSuchMethodException &#123;</span><br><span class="line">    &#x2F;&#x2F; 检查当前实现类是否实现了 type 接口</span><br><span class="line">    if (!type.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Error occurred when loading extension class (interface: &quot; +</span><br><span class="line">                type + &quot;, class line: &quot; + clazz.getName() + &quot;), class &quot;</span><br><span class="line">                + clazz.getName() + &quot; is not subtype of interface.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 当前实现类是否有 Adaptive 注解</span><br><span class="line">    if (clazz.isAnnotationPresent(Adaptive.class)) &#123;</span><br><span class="line">        cacheAdaptiveClass(clazz);</span><br><span class="line">        &#x2F;&#x2F; 当前类是否为 Wrapper 包装扩展类</span><br><span class="line">    &#125; else if (isWrapperClass(clazz)) &#123;</span><br><span class="line">        cacheWrapperClass(clazz);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 尝试当前类是否有无参构造方法</span><br><span class="line">        clazz.getConstructor();</span><br><span class="line">        if (StringUtils.isEmpty(name)) &#123;</span><br><span class="line">            &#x2F;&#x2F; 如果 name 为空，则获取 clazz 的 @Extension 注解的值，如果注解值也没有，则使用小写类名</span><br><span class="line">            name &#x3D; findAnnotationName(clazz);</span><br><span class="line">            if (name.length() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;No such extension name for the class &quot; + clazz.getName() + &quot; in the config &quot; + resourceURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] names &#x3D; NAME_SEPARATOR.split(name);</span><br><span class="line">        if (ArrayUtils.isNotEmpty(names)) &#123;</span><br><span class="line">            &#x2F;&#x2F; 缓存 扩展名和@Activate的缓存</span><br><span class="line">            cacheActivateClass(clazz, names[0]);</span><br><span class="line">            for (String n : names) &#123;</span><br><span class="line">                cacheName(clazz, n);</span><br><span class="line">                &#x2F;&#x2F; 将 扩展类和扩展名 保存到extensionClasses 扩展名-&gt;扩展类 关系映射中</span><br><span class="line">                saveInExtensionClass(extensionClasses, clazz, n);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>———————第二段代码块，华丽丽的分割线————————</p>
<p>———————第三段代码块，华丽丽的分割线————————</p>
<p>创建扩展对象的逻辑如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private T createExtension(String name) &#123;</span><br><span class="line">    &#x2F;&#x2F; 从全部扩展类中，获取当前扩展名对应的扩展类</span><br><span class="line">    Class&lt;?&gt; clazz &#x3D; getExtensionClasses().get(name);</span><br><span class="line">    if (clazz &#x3D;&#x3D; null) &#123;</span><br><span class="line">        throw findException(name);</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; 从缓存中获取扩展实例，及设置扩展实例缓存</span><br><span class="line">        T instance &#x3D; (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        if (instance &#x3D;&#x3D; null) &#123;</span><br><span class="line">            EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span><br><span class="line">            instance &#x3D; (T) EXTENSION_INSTANCES.get(clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 向当前实例注入依赖</span><br><span class="line">        injectExtension(instance);</span><br><span class="line">        &#x2F;&#x2F; 获取包装扩展类缓存</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses &#x3D; cachedWrapperClasses;</span><br><span class="line">        if (CollectionUtils.isNotEmpty(wrapperClasses)) &#123;</span><br><span class="line">            for (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;</span><br><span class="line">                &#x2F;&#x2F; 创建包装扩展类实例，并向其注入依赖</span><br><span class="line">                instance &#x3D; injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 初始化扩展对象</span><br><span class="line">        initExtension(instance);</span><br><span class="line">        return instance;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Extension instance (name: &quot; + name + &quot;, class: &quot; +</span><br><span class="line">                type + &quot;) couldn&#39;t be instantiated: &quot; + t.getMessage(), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依赖注入的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">private T injectExtension(T instance) &#123;</span><br><span class="line"></span><br><span class="line">    if (objectFactory &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; 遍历当前扩展类的全部方法，如果当前方法不属于 setter 方法，</span><br><span class="line">        &#x2F;&#x2F; 即不是以 &#39;set&#39;开头的方法名，参数不是一个的，该方法访问级别不是 public 的，则不往下执行</span><br><span class="line">        for (Method method : instance.getClass().getMethods()) &#123;</span><br><span class="line">            if (!isSetter(method)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;**</span><br><span class="line">             * Check &#123;@link DisableInject&#125; to see if we need auto injection for this property</span><br><span class="line">             *&#x2F;</span><br><span class="line">            &#x2F;&#x2F; 当前方法是否添加了不要注入依赖的注解</span><br><span class="line">            if (method.getAnnotation(DisableInject.class) !&#x3D; null) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt; pt &#x3D; method.getParameterTypes()[0];</span><br><span class="line">            if (ReflectUtils.isPrimitives(pt)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; 通过属性 setter 方法获取属性名</span><br><span class="line">                String property &#x3D; getSetterProperty(method);</span><br><span class="line">                &#x2F;&#x2F; 获取依赖对象</span><br><span class="line">                Object object &#x3D; objectFactory.getExtension(pt, property);</span><br><span class="line">                if (object !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; 设置依赖</span><br><span class="line">                    method.invoke(instance, object);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                logger.error(&quot;Failed to inject via method &quot; + method.getName()</span><br><span class="line">                        + &quot; of interface &quot; + type.getName() + &quot;: &quot; + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    return instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>———————第三段代码块，华丽丽的分割线————————</p>
<h5 id="getAdaptiveExtension的实现原理"><a href="#getAdaptiveExtension的实现原理" class="headerlink" title="getAdaptiveExtension的实现原理"></a>getAdaptiveExtension的实现原理</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public T getAdaptiveExtension() &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取实例化对象缓存</span><br><span class="line">    Object instance &#x3D; cachedAdaptiveInstance.get();</span><br><span class="line">    if (instance &#x3D;&#x3D; null) &#123;</span><br><span class="line">        if (createAdaptiveInstanceError !&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Failed to create adaptive instance: &quot; +</span><br><span class="line">                    createAdaptiveInstanceError.toString(),</span><br><span class="line">                    createAdaptiveInstanceError);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 双重检查锁后创建自适应扩展</span><br><span class="line">        synchronized (cachedAdaptiveInstance) &#123;</span><br><span class="line">            instance &#x3D; cachedAdaptiveInstance.get();</span><br><span class="line">            if (instance &#x3D;&#x3D; null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; 创建自适应扩展</span><br><span class="line">                    instance &#x3D; createAdaptiveExtension();</span><br><span class="line">                    cachedAdaptiveInstance.set(instance);</span><br><span class="line">                &#125; catch (Throwable t) &#123;</span><br><span class="line">                    createAdaptiveInstanceError &#x3D; t;</span><br><span class="line">                    throw new IllegalStateException(&quot;Failed to create adaptive instance: &quot; + t.toString(), t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private T createAdaptiveExtension() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取自适应扩展后，注入依赖</span><br><span class="line">        return injectExtension((T) getAdaptiveExtensionClass().newInstance());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Can&#39;t create adaptive extension &quot; + type + &quot;, cause: &quot; + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">    &#x2F;&#x2F; 加载全部扩展类</span><br><span class="line">    getExtensionClasses();</span><br><span class="line">    &#x2F;&#x2F; 加载全部扩展类后，如果有 @Adaptive 标注的类，cachedAdaptiveClass 则一定不会为空</span><br><span class="line">    if (cachedAdaptiveClass !&#x3D; null) &#123;</span><br><span class="line">        return cachedAdaptiveClass;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 创建自适应扩展类</span><br><span class="line">    return cachedAdaptiveClass &#x3D; createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private Class&lt;?&gt; createAdaptiveExtensionClass() &#123;</span><br><span class="line">    &#x2F;&#x2F; 生成自适应扩展代码</span><br><span class="line">    String code &#x3D; new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate();</span><br><span class="line">    &#x2F;&#x2F; 获取扩展类加载器</span><br><span class="line">    ClassLoader classLoader &#x3D; findClassLoader();</span><br><span class="line">    &#x2F;&#x2F; 获取编译器类型的实现类</span><br><span class="line">    org.apache.dubbo.common.compiler.Compiler compiler &#x3D; ExtensionLoader.getExtensionLoader(org.apache.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br><span class="line">    &#x2F;&#x2F; 编译代码，返回该对象</span><br><span class="line">    return compiler.compile(code, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="getActivateExtension的实现原理"><a href="#getActivateExtension的实现原理" class="headerlink" title="getActivateExtension的实现原理"></a>getActivateExtension的实现原理</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;T&gt; getActivateExtension(URL url, String[] values, String group) &#123;</span><br><span class="line">    List&lt;T&gt; activateExtensions &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; names &#x3D; values &#x3D;&#x3D; null ? new ArrayList&lt;&gt;(0) : Arrays.asList(values);</span><br><span class="line">    if (!names.contains(REMOVE_VALUE_PREFIX + DEFAULT_KEY)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取所有扩展类</span><br><span class="line">        getExtensionClasses();</span><br><span class="line">        &#x2F;&#x2F; 遍历所有@Active注解对象</span><br><span class="line">        for (Map.Entry&lt;String, Object&gt; entry : cachedActivates.entrySet()) &#123;</span><br><span class="line">            &#x2F;&#x2F;spi 扩展名</span><br><span class="line">            String name &#x3D; entry.getKey();</span><br><span class="line">            Object activate &#x3D; entry.getValue();</span><br><span class="line"></span><br><span class="line">            String[] activateGroup, activateValue;</span><br><span class="line"></span><br><span class="line">            if (activate instanceof Activate) &#123;</span><br><span class="line">                activateGroup &#x3D; ((Activate) activate).group();</span><br><span class="line">                activateValue &#x3D; ((Activate) activate).value();</span><br><span class="line">            &#125; else if (activate instanceof com.alibaba.dubbo.common.extension.Activate) &#123;</span><br><span class="line">                activateGroup &#x3D; ((com.alibaba.dubbo.common.extension.Activate) activate).group();</span><br><span class="line">                activateValue &#x3D; ((com.alibaba.dubbo.common.extension.Activate) activate).value();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;如果有group匹配</span><br><span class="line">            if (isMatchGroup(group, activateGroup)</span><br><span class="line">                    &amp;&amp; !names.contains(name)</span><br><span class="line">                    &amp;&amp; !names.contains(REMOVE_VALUE_PREFIX + name)</span><br><span class="line">                    &amp;&amp; isActive(activateValue, url)) &#123;</span><br><span class="line">                &#x2F;&#x2F; 向集合里添加</span><br><span class="line">                activateExtensions.add(getExtension(name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 排序Activate 具体实现在ActivateComparator里，实现了Comparator 接口compare方法</span><br><span class="line">        activateExtensions.sort(ActivateComparator.COMPARATOR);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;T&gt; loadedExtensions &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">    for (int i &#x3D; 0; i &lt; names.size(); i++) &#123;</span><br><span class="line">        String name &#x3D; names.get(i);</span><br><span class="line">        if (!name.startsWith(REMOVE_VALUE_PREFIX)</span><br><span class="line">                &amp;&amp; !names.contains(REMOVE_VALUE_PREFIX + name)) &#123;</span><br><span class="line">            &#x2F;&#x2F;遍历所有没有排除的扩展名</span><br><span class="line">            if (DEFAULT_KEY.equals(name)) &#123;</span><br><span class="line">                if (!loadedExtensions.isEmpty()) &#123;</span><br><span class="line">                    activateExtensions.addAll(0, loadedExtensions);</span><br><span class="line">                    loadedExtensions.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F;通过扩展名，加载扩展添加到结果集</span><br><span class="line">                loadedExtensions.add(getExtension(name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!loadedExtensions.isEmpty()) &#123;</span><br><span class="line">        activateExtensions.addAll(loadedExtensions);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 返回符合条件的扩展类</span><br><span class="line">    return activateExtensions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://wry1610.com/2020/05/09/Dubbo%E8%BF%9B%E9%98%B6%EF%BC%88%E4%B8%83%EF%BC%89%EF%BC%9ADubbo%E6%89%A9%E5%B1%95%E7%82%B9%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%EF%BC%88%E4%B8%8B%EF%BC%89/" data-id="ck9zgrcy00009evhpf2dvgygi" class="article-share-link">
                                            分享
                                        </a>
                                        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%EF%BC%8CRPC%EF%BC%8CDubbo/" rel="tag">分布式，RPC，Dubbo</a></li></ul>

                                    </footer>

    </div>

    
        
  <nav class="article-nav">
    
    
      <a href="/2020/04/30/Dubbo%E8%BF%9B%E9%98%B6%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9ADubbo%E6%89%A9%E5%B1%95%E7%82%B9%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%EF%BC%88%E4%B8%AD%EF%BC%89/" class="article-nav-link">
        <strong class="article-nav-caption">后一篇</strong>
        <div class="article-nav-title">Dubbo进阶（六）：Dubbo扩展点加载机制（中）</div>
      </a>
    
  </nav>


            

                
                    
                        
  <div class="gitalk" id="gitalk-container"></div>
  
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

  
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>

  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: 'dc4bc5e8db8ad0c02feb',
      clientSecret: 'e34658b398507219c612f0217783e96033c4cd4b',
      repo: 'BazookaW.github.io',
      owner: 'BazookaW',
      admin: ['BazookaW'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

                            

</article>
</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
    <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 Wry&#39;s blog</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean" target="_blank" rel="noopener">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/favicon.ico" alt="Wry&#39;s blog"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">首页</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">归档</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/category">分类</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">关于</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>

<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>



<script src="/js/ocean.js"></script>


</body>
</html>